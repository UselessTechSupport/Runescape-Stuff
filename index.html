
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>RS3 Leagues Synergy Planner</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">
  <div class="max-w-7xl mx-auto p-4 md:p-8">

    <!-- Header -->
    <div class="bg-white p-6 md:p-8 rounded-2xl shadow-lg mb-8">
      <h1 class="text-4xl font-bold text-center mb-2 text-gray-900">Catalyst League Planner</h1>
      <p class="text-center text-lg text-gray-600 mb-6">Select your relics to find the most synergistic tasks.</p>

      <!-- Relic dropdowns (rendered by JS) -->
      <div id="relic-planner" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 mb-6"></div>

      <!-- Selected relics -->
      <div id="selected-relics-container" class="mt-6 p-4 bg-gray-50 rounded-lg shadow-inner hidden">
        <h3 class="text-xl font-bold mb-2 text-gray-800">Your Relic Build</h3>
        <div class="overflow-x-auto rounded-lg">
          <table id="selected-relics-table" class="min-w-full rounded-lg">
            <thead class="bg-gray-200">
              <tr>
                <th class="px-4 py-2 text-left text-sm font-semibold text-gray-600 rounded-tl-lg">Tier</th>
                <th class="px-4 py-2 text-left text-sm font-semibold text-gray-600">Relic</th>
                <th class="px-4 py-2 text-left text-sm font-semibold text-gray-600 rounded-tr-lg">Description</th>
              </tr>
            </thead>
            <tbody id="selected-relics-table-body" class="bg-white"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Custom Synergy -->
    <div class="bg-white p-6 md:p-8 rounded-2xl shadow-lg mb-8">
      <h2 class="text-3xl font-bold mb-4 text-gray-900">Custom Synergy Rules</h2>
      <div id="custom-synergy-controls" class="space-y-4">
        <div class="flex flex-col md:flex-row items-center md:space-x-4 space-y-4 md:space-y-0">
          <input type="text" id="synergy-name-input" placeholder="Enter synergy name" class="flex-grow p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200">
          <button id="save-synergy-btn" class="w-full md:w-auto px-6 py-2 rounded-full bg-blue-500 text-white font-bold hover:bg-blue-600 transition-colors duration-200">Save Custom Synergy</button>
        </div>
        <div id="synergy-categories" class="flex flex-wrap gap-2 justify-center"></div>
        <div id="saved-synergies-list" class="flex flex-wrap gap-2 justify-center pt-4 border-t border-gray-200"></div>
      </div>
    </div>

    <!-- Route Planner -->
    <div class="bg-white p-6 md:p-8 rounded-2xl shadow-lg mb-8">
      <h2 class="text-3xl font-bold mb-4 text-gray-900">Route Planner</h2>
      <div id="area-buttons" class="flex flex-wrap gap-2 mb-4">
        <button class="rounded-full px-5 py-2 font-medium bg-blue-500 text-white shadow-md transition-all duration-200 active" data-area-filter="all">All Areas</button>
      </div>
    </div>

    <!-- Task Tracker -->
    <div class="bg-white p-6 md:p-8 rounded-2xl shadow-lg">
      <h2 class="text-3xl font-bold mb-4 text-gray-900">Task Tracker</h2>
      <div class="flex flex-col sm:flex-row items-center gap-4 mb-4">
        <input type="text" id="task-search" placeholder="Search tasks..." class="w-full sm:w-1/2 p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200">
        <select id="sort-by" class="w-full sm:w-auto p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200">
          <option value="points-desc">Sort by Points (High to Low)</option>
          <option value="synergy-desc">Sort by Synergy (High to Low)</option>
          <option value="points-asc">Sort by Points (Low to High)</option>
        </select>
        <div id="synergy-mode-toggle" class="flex space-x-2">
          <button class="rounded-full px-4 py-2 font-medium bg-blue-500 text-white transition-all duration-200 active" data-synergy-mode="relic">Relic Synergy</button>
          <button class="rounded-full px-4 py-2 font-medium bg-gray-300 text-gray-700 transition-all duration-200" data-synergy-mode="custom">Custom Synergy</button>
        </div>
      </div>

      <!-- Total Synergy Points -->
      <div id="synergy-summary" class="mb-4 p-4 bg-blue-50 rounded-lg text-gray-800 font-medium hidden">
        Total Synergy Points: <span id="total-synergy-points">0</span>
        <div id="top-tasks" class="mt-2 text-sm text-gray-700"></div>
      </div>

      <div class="overflow-x-auto rounded-lg">
        <table id="task-table" class="min-w-full bg-white rounded-lg">
          <thead class="bg-gray-200">
            <tr>
              <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600 rounded-tl-lg">Task</th>
              <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Points</th>
              <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Requirements</th>
              <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600 rounded-tr-lg">Synergy Score</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
/* ---------------------------
   State & DOM references
   --------------------------- */
let relics = [];
let tasks = [];
const availableCategories = ['Clues','Gathering','Production','Combat','Skilling','Utility','Dungeons','Bossing','Slayer','PVM','General'];
const categoryIcons = {
  'Clues':'🗺️','Gathering':'⛏️','Production':'🛠️','Combat':'⚔️','Skilling':'🎓','Utility':'🎒','Dungeons':'🗝️','Bossing':'👹','Slayer':'🐉','PVM':'🛡️','General':'✨'
};

let selectedRelics = {}; // { tierNumber: { name, synergies, tier } }
let customSynergies = []; // { id, name, categories: [] }
let selectedCustomSynergyId = null;
let synergyMode = 'relic';
let currentAreaFilter = 'all';

/* DOM refs */
const relicPlannerEl = document.getElementById('relic-planner');
const selectedRelicsContainerEl = document.getElementById('selected-relics-container');
const selectedRelicsTableBodyEl = document.getElementById('selected-relics-table-body');
const taskTableBodyEl = document.querySelector('#task-table tbody');
const taskSearchEl = document.getElementById('task-search');
const sortByEl = document.getElementById('sort-by');
const areaButtonsEl = document.getElementById('area-buttons');
const synergyNameInput = document.getElementById('synergy-name-input');
const saveSynergyBtn = document.getElementById('save-synergy-btn');
const synergyCategoriesEl = document.getElementById('synergy-categories');
const savedSynergiesListEl = document.getElementById('saved-synergies-list');
const synergyModeToggleEl = document.getElementById('synergy-mode-toggle');
const synergySummaryEl = document.getElementById('synergy-summary');
const totalPointsEl = document.getElementById('total-synergy-points');
const topTasksEl = document.getElementById('top-tasks');

/* ---------------------------
   Load JSON Data
   --------------------------- */
async function loadData() {
  try {
    const relicsResponse = await fetch('relics.json');
    relics = await relicsResponse.json();

    const tasksResponse = await fetch('tasks.json');
    tasks = await tasksResponse.json();
  } catch (err) {
    console.error('Error loading JSON data:', err);
  }
}

/* ---------------------------
   Category detection
   --------------------------- */
function getTaskCategory(task) {
  const lower = task.toLowerCase();
  if (lower.includes('clue') || lower.includes('casket') || lower.includes('treasure trail')) return 'Clues';
  if (lower.includes('woodcutting') || lower.includes('mining') || lower.includes('fishing') || lower.includes('gather') || lower.includes('harvest')) return 'Gathering';
  if (lower.includes('craft') || lower.includes('smith') || lower.includes('fletch') || lower.includes('cook') || lower.includes('make') || lower.includes('rune helm')) return 'Production';
  if (lower.includes('kill') || lower.includes('slay') || lower.includes('defeat') || lower.includes('combat') || lower.includes('fight') || lower.includes('attack') || lower.includes('pvp')) return 'Combat';
  if (lower.includes('skill') || lower.includes('level') || lower.includes('xp') || lower.includes('agility') || lower.includes('firemaking')) return 'Skilling';
  if (lower.includes('bank') || lower.includes('runespan') || lower.includes('teleport') || lower.includes('lootbag') || lower.includes('loot bag')) return 'Utility';
  if (lower.includes('dungeon') || lower.includes('dungeoneering')) return 'Dungeons';
  if (lower.includes('boss')) return 'Bossing';
  if (lower.includes('slayer')) return 'Slayer';
  if (lower.includes('pvm')) return 'PVM';
  return 'General';
}

/* ---------------------------
   Synergy scoring
   --------------------------- */
function calculateRelicSynergyScore(task) {
  const taskCategory = getTaskCategory(task.Task);
  if (!taskCategory) return { score:0, details:[] };
  let score = 0;
  const details = [];

  relics.forEach(relicTier => {
    const sel = selectedRelics[relicTier.Tier];
    if (!sel) return;

    if (Array.isArray(relicTier.PassiveSynergy) && relicTier.PassiveSynergy.includes(taskCategory)) {
      score += 1;
      details.push(`${sel.name} (tier passive)`);
    }

    if (Array.isArray(sel.synergies) && sel.synergies.includes(taskCategory)) {
      score += 1;
      details.push(`${sel.name} (active)`);
    }
  });

  if (score > 5) score = 5;
  return { score, details };
}

function calculateCustomSynergyScore(task) {
  if (!selectedCustomSynergyId) return { score:0, details:[] };
  const chosen = customSynergies.find(s => s.id === selectedCustomSynergyId);
  if (!chosen) return { score:0, details:[] };
  const taskCategory = getTaskCategory(task.Task);
  const details = [];
  let score = 0;
  if (Array.isArray(chosen.categories) && chosen.categories.includes(taskCategory)) {
    score += 1;
    details.push(`Custom: ${chosen.name}`);
  }
  if (score > 5) score = 5;
  return { score, details };
}

/* ---------------------------
   Rendering
   --------------------------- */
function escapeHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function renderSelectedRelicDetails() {
  selectedRelicsTableBodyEl.innerHTML = '';
  const tiers = Object.keys(selectedRelics).map(Number).sort((a,b)=>a-b);
  if (!tiers.length) { selectedRelicsContainerEl.classList.add('hidden'); return; }
  selectedRelicsContainerEl.classList.remove('hidden');

  tiers.forEach(tier => {
    const sel = selectedRelics[tier];
    const relicTierData = relics.find(r => r.Tier === tier);
    let details = '';
    if (relicTierData) {
      if (sel.name === relicTierData.Relic1) details = relicTierData.Relic1Details || '';
      else if (sel.name === relicTierData.Relic2) details = relicTierData.Relic2Details || '';
      else if (sel.name === relicTierData.Relic3) details = relicTierData.Relic3Details || '';
    }

    const tr = document.createElement('tr');
    tr.className = 'border-b border-gray-200';
    tr.innerHTML = `
      <td class="px-4 py-2 text-sm text-gray-900">Tier ${tier}</td>
      <td class="px-4 py-2 text-sm text-gray-900">${sel.name}</td>
      <td class="px-4 py-2 text-sm text-gray-900">${details}</td>
    `;
    selectedRelicsTableBodyEl.appendChild(tr);
  });
}

function renderRelicDropdowns() {
  relicPlannerEl.innerHTML = '';
  relics.forEach(relic => {
    const wrapper = document.createElement('div');
    wrapper.className = "bg-gray-100 p-4 rounded-lg shadow-inner";
    wrapper.innerHTML = `
      <label class="block text-sm font-medium text-gray-700 mb-1">Tier ${relic.Tier}</label>
      <select class="relic-select block w-full rounded-md shadow-sm p-2 text-gray-700" data-tier="${relic.Tier}">
        <option value="">Select Relic</option>
        ${relic.Relic1 ? `<option value="${escapeHtml(relic.Relic1)}">${escapeHtml(relic.Relic1)}</option>` : ''}
        ${relic.Relic2 ? `<option value="${escapeHtml(relic.Relic2)}">${escapeHtml(relic.Relic2)}</option>` : ''}
        ${relic.Relic3 ? `<option value="${escapeHtml(relic.Relic3)}">${escapeHtml(relic.Relic3)}</option>` : ''}
      </select>
    `;
    relicPlannerEl.appendChild(wrapper);

    const selectEl = wrapper.querySelector('select');
    selectEl.addEventListener('change', (e) => {
      const val = e.target.value;
      const tierNum = Number(e.target.dataset.tier);
      if (val) {
        const chosen = relics.find(r => r.Relic1 === val || r.Relic2 === val || r.Relic3 === val);
        if (chosen) selectedRelics[tierNum] = { name: val, synergies: chosen.Synergy || [], tier: tierNum };
      } else delete selectedRelics[tierNum];
      renderSelectedRelicDetails();
      renderTasks();
      saveRelicsToStorage();
    });

    if (selectedRelics[relic.Tier]) selectEl.value = selectedRelics[relic.Tier].name;
  });
}

function renderAreaButtons() {
  areaButtonsEl.querySelectorAll('button[data-area-filter]').forEach(btn => {
    if (btn.dataset.areaFilter !== 'all') btn.remove();
  });

  const areas = [...new Set(tasks.map(t => t.Area))].sort();
  areas.forEach(area => {
    const btn = document.createElement('button');
    btn.className = 'area-button';
    btn.textContent = area;
    btn.dataset.areaFilter = area;
    areaButtonsEl.appendChild(btn);
    btn.addEventListener('click', () => {
      areaButtonsEl.querySelectorAll('.area-button').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentAreaFilter = area;
      renderTasks();
    });
  });
}

function renderSynergyCategories() {
  synergyCategoriesEl.innerHTML = '';
  availableCategories.forEach(cat => {
    const btn = document.createElement('button');
    btn.textContent = categoryIcons[cat] + ' ' + cat;
    btn.className = 'synergy-category-button';
    btn.dataset.category = cat;
    btn.addEventListener('click', () => {
      if (!selectedCustomSynergyId) return;
      const chosen = customSynergies.find(s => s.id === selectedCustomSynergyId);
      if (!chosen) return;
      if (chosen.categories.includes(cat)) chosen.categories = chosen.categories.filter(c => c !== cat);
      else chosen.categories.push(cat);
      renderSynergyCategories();
      renderTasks();
      saveCustomSynergies();
    });
    if (selectedCustomSynergyId) {
      const chosen = customSynergies.find(s => s.id === selectedCustomSynergyId);
      if (chosen && chosen.categories.includes(cat)) btn.classList.add('active');
    }
    synergyCategoriesEl.appendChild(btn);
  });
}

function renderTasks() {
  taskTableBodyEl.innerHTML = '';
  const searchTerm = taskSearchEl.value.toLowerCase();

  const filtered = tasks.filter(t => {
    if (currentAreaFilter !== 'all' && t.Area !== currentAreaFilter) return false;
    if (!t.Task.toLowerCase().includes(searchTerm)) return false;
    return true;
  });

  filtered.sort((a,b)=>{
    const getScore = t => synergyMode==='relic'? calculateRelicSynergyScore(t).score : calculateCustomSynergyScore(t).score;
    return getScore(b)-getScore(a);
  });

filtered.forEach(task => {
  const { score } = synergyMode==='relic' 
    ? calculateRelicSynergyScore(task) 
    : calculateCustomSynergyScore(task);

  const tr = document.createElement('tr');
  tr.className = "border-b border-gray-200";
  tr.innerHTML = `
    <td class="px-4 py-2 text-sm">${escapeHtml(task.Task)}</td>
    <td class="px-4 py-2 text-sm">${task.Points || 0}</td>
    <td class="px-4 py-2 text-sm">${escapeHtml(task.Requirements || 'N/A')}</td>
    <td class="px-4 py-2 text-sm">${score}</td>
  `;
  taskTableBodyEl.appendChild(tr);
});

  const totalPoints = filtered.reduce((sum, t) => {
    const s = synergyMode==='relic'? calculateRelicSynergyScore(t).score : calculateCustomSynergyScore(t).score;
    return sum + s;
  }, 0);
  totalPointsEl.textContent = totalPoints;
}

/* ---------------------------
   Local Storage
   --------------------------- */
function saveRelicsToStorage() {
  localStorage.setItem('selectedRelics', JSON.stringify(selectedRelics));
}

function restoreRelicsFromStorage() {
  const data = localStorage.getItem('selectedRelics');
  if (!data) return;
  selectedRelics = JSON.parse(data);
}

function saveCustomSynergies() {
  localStorage.setItem('customSynergies', JSON.stringify(customSynergies));
}

function loadCustomSynergies() {
  const data = localStorage.getItem('customSynergies');
  if (!data) return;
  customSynergies = JSON.parse(data);
}

/* ---------------------------
   Event listeners
   --------------------------- */
taskSearchEl.addEventListener('input', renderTasks);
synergyModeToggleEl.addEventListener('change', e => {
  synergyMode = e.target.checked ? 'custom' : 'relic';
  renderTasks();
});

saveSynergyBtn.addEventListener('click', () => {
  const name = synergyNameInput.value.trim();
  if (!name) return;
  const id = Date.now();
  customSynergies.push({ id, name, categories: [] });
  selectedCustomSynergyId = id;
  renderSynergyCategories();
  renderTasks();
  saveCustomSynergies();
  synergyNameInput.value = '';
});

/* ---------------------------
   Init
   --------------------------- */
(async function init() {
  await loadData();
  restoreRelicsFromStorage();
  loadCustomSynergies();
  renderRelicDropdowns();
  renderSelectedRelicDetails();
  renderAreaButtons();
  renderSynergyCategories();
  renderTasks();

  setInterval(saveRelicsToStorage, 2000);
})();
</script>
</body>
</html>
