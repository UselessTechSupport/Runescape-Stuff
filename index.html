
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>RS3 Leagues Synergy Planner</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">
  <div class="max-w-7xl mx-auto p-4 md:p-8">

    <!-- Header -->
    <div class="bg-white p-6 md:p-8 rounded-2xl shadow-lg mb-8">
      <h1 class="text-4xl font-bold text-center mb-2 text-gray-900">Catalyst League Planner</h1>
      <p class="text-center text-lg text-gray-600 mb-6">Select your relics to find the most synergistic tasks.</p>
<div class="flex justify-end mb-4">
  <button id="clear-relics-btn" class="px-4 py-2 rounded-full bg-red-500 text-white font-bold hover:bg-red-600 transition-colors duration-200">
    Clear Relics
  </button>
</div>
      <!-- Relic dropdowns (rendered by JS) -->
      <div id="relic-planner" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 mb-6"></div>

      <!-- Selected relics -->
      <div id="selected-relics-container" class="mt-6 p-4 bg-gray-50 rounded-lg shadow-inner hidden">
        <h3 class="text-xl font-bold mb-2 text-gray-800">Your Relic Build</h3>
        <div class="overflow-x-auto rounded-lg">
          <table id="selected-relics-table" class="min-w-full rounded-lg">
            <thead class="bg-gray-200">
              <tr>
                <th class="px-4 py-2 text-left text-sm font-semibold text-gray-600 rounded-tl-lg">Tier</th>
                <th class="px-4 py-2 text-left text-sm font-semibold text-gray-600">Relic</th>
                <th class="px-4 py-2 text-left text-sm font-semibold text-gray-600 rounded-tr-lg">Description</th>
              </tr>
            </thead>
            <tbody id="selected-relics-table-body" class="bg-white"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Custom Synergy -->
    <div class="bg-white p-6 md:p-8 rounded-2xl shadow-lg mb-8">
      <h2 class="text-3xl font-bold mb-4 text-gray-900">Custom Synergy Rules</h2>
      <div id="custom-synergy-controls" class="space-y-4">
        <div class="flex flex-col md:flex-row items-center md:space-x-4 space-y-4 md:space-y-0">
          <input type="text" id="synergy-name-input" placeholder="Enter synergy name" class="flex-grow p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200">
          <button id="save-synergy-btn" class="w-full md:w-auto px-6 py-2 rounded-full bg-blue-500 text-white font-bold hover:bg-blue-600 transition-colors duration-200">Save Custom Synergy</button>
        </div>
        <div id="synergy-categories" class="flex flex-wrap gap-2 justify-center"></div>
        <div id="saved-synergies-list" class="flex flex-wrap gap-2 justify-center pt-4 border-t border-gray-200"></div>
      </div>
    </div>

    <!-- Route Planner -->
    <div class="bg-white p-6 md:p-8 rounded-2xl shadow-lg mb-8">
      <h2 class="text-3xl font-bold mb-4 text-gray-900">Route Planner</h2>
      <div id="area-buttons" class="flex flex-wrap gap-2 mb-4">
        <button class="rounded-full px-5 py-2 font-medium bg-blue-500 text-white shadow-md transition-all duration-200 active" data-area-filter="all">All Areas</button>
      </div>
    </div>

    <!-- Task Tracker -->
	<div id="task-category-filters" class="flex flex-wrap gap-2 mb-4"></div>
    <div class="bg-white p-6 md:p-8 rounded-2xl shadow-lg">
      <h2 class="text-3xl font-bold mb-4 text-gray-900">Task Tracker</h2>
      <div class="flex flex-col sm:flex-row items-center gap-4 mb-4">
        <input type="text" id="task-search" placeholder="Search tasks..." class="w-full sm:w-1/2 p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200">
        <select id="sort-by" class="w-full sm:w-auto p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200">
          <option value="points-desc">Sort by Points (High to Low)</option>
		  <option value="points-asc">Sort by Points (Low to High)</option>
          <option value="synergy-desc">Sort by Synergy (High to Low)</option>
		  <option value="synergy-asc">Sort by Synergy (Low to High)</option>          
        </select>
        <div id="synergy-mode-toggle" class="flex space-x-2">
          <button class="rounded-full px-4 py-2 font-medium bg-blue-500 text-white transition-all duration-200 active" data-synergy-mode="relic">Relic Synergy</button>
          <button class="rounded-full px-4 py-2 font-medium bg-gray-300 text-gray-700 transition-all duration-200" data-synergy-mode="custom">Custom Synergy</button>
        </div>
      </div>

      <!-- Total Synergy Points -->
      <div id="synergy-summary" class="mb-4 p-4 bg-blue-50 rounded-lg text-gray-800 font-medium hidden">
        Total Synergy Points: <span id="total-synergy-points">0</span>
        <div id="top-tasks" class="mt-2 text-sm text-gray-700"></div>
      </div>

      <div class="overflow-x-auto rounded-lg">
        <table id="task-table" class="min-w-full bg-white rounded-lg">
          <thead class="bg-gray-200">
            <tr>
              <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600 rounded-tl-lg">Task</th>
              <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Points</th>
              <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Requirements</th>
              <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600 rounded-tr-lg">Synergy Score</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
/* ---------------------------
   State & DOM references
   --------------------------- */
let relics = [];
let tasks = [];
const availableCategories = ['Clues','Gathering','Production','Combat','Skilling','Utility','Dungeons','Bossing','Slayer','PVM','General'];
const categoryIcons = {
  'Clues':'ðŸ—ºï¸','Gathering':'â›ï¸','Production':'ðŸ› ï¸','Combat':'âš”ï¸','Skilling':'ðŸŽ“','Utility':'ðŸŽ’','Dungeons':'ðŸ—ï¸','Bossing':'ðŸ‘¹','Slayer':'ðŸ‰','PVM':'ðŸ›¡ï¸','General':'âœ¨'
};

let selectedRelics = {}; // { tierNumber: { name, synergies, tier } }
let customSynergies = []; // { id, name, categories: [] }
let selectedCustomSynergyId = null;
let synergyMode = 'relic';
let currentAreaFilter = 'all';

/* DOM refs */
const relicPlannerEl = document.getElementById('relic-planner');
const selectedRelicsContainerEl = document.getElementById('selected-relics-container');
const selectedRelicsTableBodyEl = document.getElementById('selected-relics-table-body');
const taskTableBodyEl = document.querySelector('#task-table tbody');
const taskSearchEl = document.getElementById('task-search');
const sortByEl = document.getElementById('sort-by');
const areaButtonsEl = document.getElementById('area-buttons');
const synergyNameInput = document.getElementById('synergy-name-input');
const saveSynergyBtn = document.getElementById('save-synergy-btn');
const synergyCategoriesEl = document.getElementById('synergy-categories');
const savedSynergiesListEl = document.getElementById('saved-synergies-list');
const synergyModeToggleEl = document.getElementById('synergy-mode-toggle');
const synergySummaryEl = document.getElementById('synergy-summary');
const totalPointsEl = document.getElementById('total-synergy-points');
const topTasksEl = document.getElementById('top-tasks');

/* ---------------------------
   Load JSON Data
   --------------------------- */
async function loadData() {
  try {
    const relicsResponse = await fetch('relics.json');
    relics = await relicsResponse.json();

    const tasksResponse = await fetch('tasks.json');
    tasks = await tasksResponse.json();
  } catch (err) {
    console.error('Error loading JSON data:', err);
  }
}

/* ---------------------------
   Category detection
   --------------------------- */
function getTaskCategory(task) {
  const lower = task.toLowerCase();
  if (lower.includes('clue') || lower.includes('casket') || lower.includes('treasure trail')) return 'Clues';
  if (lower.includes('woodcutting') || lower.includes('mining') || lower.includes('fishing') || lower.includes('gather') || lower.includes('harvest')) return 'Gathering';
  if (lower.includes('craft') || lower.includes('smith') || lower.includes('fletch') || lower.includes('cook') || lower.includes('make') || lower.includes('rune helm')) return 'Production';
  if (lower.includes('kill') || lower.includes('slay') || lower.includes('defeat') || lower.includes('combat') || lower.includes('fight') || lower.includes('attack') || lower.includes('pvp')) return 'Combat';
  if (lower.includes('skill') || lower.includes('level') || lower.includes('xp') || lower.includes('agility') || lower.includes('firemaking')) return 'Skilling';
  if (lower.includes('bank') || lower.includes('runespan') || lower.includes('teleport') || lower.includes('lootbag') || lower.includes('loot bag')) return 'Utility';
  if (lower.includes('dungeon') || lower.includes('dungeoneering')) return 'Dungeons';
  if (lower.includes('boss')) return 'Bossing';
  if (lower.includes('slayer')) return 'Slayer';
  if (lower.includes('pvm')) return 'PVM';
  return 'General';
}

/* ---------------------------
   Synergy scoring
   --------------------------- */
function calculateRelicSynergyScore(task) {
  const taskCategory = getTaskCategory(task.Task);
  if (!taskCategory) return { score:0, details:[] };
  let score = 0;
  const details = [];

  relics.forEach(relicTier => {
    const sel = selectedRelics[relicTier.Tier];
    if (!sel) return;

    if (Array.isArray(relicTier.PassiveSynergy) && relicTier.PassiveSynergy.includes(taskCategory)) {
      score += 1;
      details.push(`${sel.name} (tier passive)`);
    }

    if (Array.isArray(sel.synergies) && sel.synergies.includes(taskCategory)) {
      score += 1;
      details.push(`${sel.name} (active)`);
    }
  });

  if (score > 5) score = 5;
  return { score, details };
}

function calculateCustomSynergyScore(task) {
  if (!selectedCustomSynergyId) return { score:0, details:[] };
  const chosen = customSynergies.find(s => s.id === selectedCustomSynergyId);
  if (!chosen) return { score:0, details:[] };
  const taskCategory = getTaskCategory(task.Task);
  const details = [];
  let score = 0;
  if (Array.isArray(chosen.categories) && chosen.categories.includes(taskCategory)) {
    score += 1;
    details.push(`Custom: ${chosen.name}`);
  }
  if (score > 5) score = 5;
  return { score, details };
}

/* ---------------------------
   Rendering
   --------------------------- */
function escapeHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function renderSelectedRelicDetails() {
  selectedRelicsTableBodyEl.innerHTML = '';
  const tiers = Object.keys(selectedRelics).map(Number).sort((a, b) => a - b);
  if (!tiers.length) {
    selectedRelicsContainerEl.classList.add('hidden');
    return;
  }
  selectedRelicsContainerEl.classList.remove('hidden');

  tiers.forEach(tier => {
    const sel = selectedRelics[tier];
    const relicTierData = relics.find(r => r.Tier === tier);

    let details = '';
    let imageUrl = '';
    let displayName = sel.name;

    if (relicTierData) {
      // Special case: Tier 4, Relic2
      if (tier === 4 && sel.name === relicTierData.Relic2) {
        const lowerTiers = relicTierData.Relic2SelectableTiers || [1, 2, 3];
        const selectableRelics = [];

        lowerTiers.forEach(t => {
          const lowerTierData = relics.find(r => r.Tier === t);
          if (!lowerTierData) return;
          ['Relic1', 'Relic2', 'Relic3', 'Relic4'].forEach(key => {
            if (lowerTierData[key]) {
              selectableRelics.push({
                name: lowerTierData[key],
                details: lowerTierData[key + 'Details'] || '',
                image: lowerTierData[key + 'Image'] || ''
              });
            }
          });
        });

        // Set initial selection
        const initialRelic = selectableRelics.find(r => r.name === sel.name) || selectableRelics[0];
        details = initialRelic.details;
        const tier4Image = relicTierData.Relic2Image || '';
        const chosenImage = initialRelic.image;

        // Render table row with side-by-side images
        const tr = document.createElement('tr');
        tr.className = 'border-b border-gray-200';
        tr.innerHTML = `
          <td class="px-4 py-2 text-sm text-gray-900">Tier ${tier}</td>
          <td class="px-4 py-2 text-sm text-gray-900 flex flex-col gap-2">
            <div class="flex items-center gap-2">
              <img src="${tier4Image}" class="w-14 h-14 object-contain rounded-full" id="tier4-icon">
              <img src="${chosenImage}" class="w-12 h-12 object-contain rounded-full tier4-chosen-img">
            </div>
            <select class="tier4-relic2-select w-full p-1 border rounded">
              ${selectableRelics.map(r => `<option value="${r.name}" ${r.name === initialRelic.name ? 'selected' : ''}>${r.name}</option>`).join('')}
            </select>
          </td>
          <td class="px-4 py-2 text-sm text-gray-900" id="tier4-relic2-details">${details}</td>
        `;
        selectedRelicsTableBodyEl.appendChild(tr);

        // Add listener to update chosen relic image & details dynamically
        const selectEl = tr.querySelector('.tier4-relic2-select');
        const detailsEl = tr.querySelector('#tier4-relic2-details');
        const chosenImgEl = tr.querySelector('.tier4-chosen-img');

        selectEl.addEventListener('change', (e) => {
          const chosen = selectableRelics.find(r => r.name === e.target.value);
          if (chosen) {
            detailsEl.textContent = chosen.details;
            chosenImgEl.src = chosen.image;
            selectedRelics[tier].name = chosen.name; // update global selection
          }
        });

        return; // skip normal rendering for this row
      }

      // Normal relics rendering
      ['Relic1', 'Relic2', 'Relic3', 'Relic4'].forEach(key => {
        if (sel.name === relicTierData[key]) {
          details = relicTierData[key + 'Details'] || '';
          imageUrl = relicTierData[key + 'Image'] || '';
        }
      });
    }

    const tr = document.createElement('tr');
    tr.className = 'border-b border-gray-200';
    tr.innerHTML = `
      <td class="px-4 py-2 text-sm text-gray-900">Tier ${tier}</td>
      <td class="px-4 py-2 text-sm text-gray-900 flex items-center gap-2">
        ${imageUrl ? `<img src="${imageUrl}" class="w-6 h-6 object-contain rounded-full">` : ''}
        ${displayName}
      </td>
      <td class="px-4 py-2 text-sm text-gray-900">${details}</td>
    `;
    selectedRelicsTableBodyEl.appendChild(tr);
  });
}






function renderRelicDropdowns() {
  relicPlannerEl.innerHTML = '';
  relics.forEach(relic => {
    const wrapper = document.createElement('div');
    wrapper.className = "bg-gray-100 p-4 rounded-lg shadow-inner";
    wrapper.innerHTML = `
      <label class="block text-sm font-medium text-gray-700 mb-1">Tier ${relic.Tier}</label>
      <div class="relic-dropdown relative">
        <button class="relic-select-btn w-full rounded-md p-2 bg-white border border-gray-300 text-left flex items-center gap-2">
          Select Relic
        </button>
        <div class="relic-options absolute z-10 left-0 right-0 mt-1 bg-white border border-gray-300 rounded-md shadow-lg hidden">
          ${[1,2,3,4].map(i => {
            const name = relic[`Relic${i}`];
            const img = relic[`Relic${i}Image`] || '';
            return name ? `<div class="relic-option flex items-center gap-2 p-2 hover:bg-gray-100 cursor-pointer" data-name="${name}">
              ${img ? `<img src="${img}" class="w-6 h-6 object-contain rounded-full">` : ''}
              ${name}
            </div>` : '';
          }).join('')}
        </div>
      </div>
    `;
    relicPlannerEl.appendChild(wrapper);

    const btn = wrapper.querySelector('.relic-select-btn');
    const optionsContainer = wrapper.querySelector('.relic-options');

    btn.addEventListener('click', () => {
      optionsContainer.classList.toggle('hidden');
    });

    optionsContainer.querySelectorAll('.relic-option').forEach(option => {
      option.addEventListener('click', (e) => {
        const val = option.dataset.name;
        const tierNum = relic.Tier;
        const chosen = relics.find(r => r.Relic1 === val || r.Relic2 === val || r.Relic3 === val || r.Relic4 === val);
        if (chosen) selectedRelics[tierNum] = { name: val, synergies: chosen.Synergy || [], tier: tierNum };
        renderSelectedRelicDetails();
        renderTasks();
        saveRelicsToStorage();
        btn.textContent = ''; 
        if (option.querySelector('img')) btn.appendChild(option.querySelector('img').cloneNode());
        btn.appendChild(document.createTextNode(val));
        optionsContainer.classList.add('hidden');
      });
    });
  });
}



function renderAreaButtons() {
  // Remove all existing buttons except "All Areas"
  areaButtonsEl.querySelectorAll('button[data-area-filter]').forEach(btn => {
    if (btn.dataset.areaFilter !== 'all' && btn.id !== 'clear-area-btn') btn.remove();
  });

const areas = [...new Set(tasks.map(t => t.Area))]
                .filter(a => a && a.toLowerCase() !== 'all' && a.toLowerCase() !== 'any')
                .sort();

  areas.forEach(area => {
    const btn = document.createElement('button');
    btn.className = 'area-button rounded-full px-5 py-2 font-medium bg-gray-300 text-gray-700 hover:bg-blue-400 hover:text-white transition-all duration-200';
    btn.textContent = area;
    btn.dataset.areaFilter = area;

    btn.addEventListener('click', () => {
      // Toggle selection for clicked button
      const isActive = btn.classList.contains('bg-blue-500');

      // Deselect all buttons first
      areaButtonsEl.querySelectorAll('.area-button').forEach(b => {
        b.classList.remove('bg-blue-500', 'text-white');
        b.classList.add('bg-gray-300', 'text-gray-700');
      });

      if (!isActive) {
        // Activate clicked button
        btn.classList.add('bg-blue-500', 'text-white');
        btn.classList.remove('bg-gray-300', 'text-gray-700');
        currentAreaFilter = area;
      } else {
        // If deselecting, fallback to "All Areas"
        currentAreaFilter = 'all';
        const allBtn = areaButtonsEl.querySelector('button[data-area-filter="all"]');
        allBtn.classList.add('bg-blue-500', 'text-white');
        allBtn.classList.remove('bg-gray-300', 'text-gray-700');
      }

      renderTasks();
    });

    areaButtonsEl.appendChild(btn);
  });

  // Ensure "All Areas" is styled correctly by default
  const allBtn = areaButtonsEl.querySelector('button[data-area-filter="all"]');
  allBtn.classList.add('bg-blue-500', 'text-white');
  allBtn.classList.remove('bg-gray-300', 'text-gray-700');
}


function renderSynergyCategories() {
  synergyCategoriesEl.innerHTML = '';

  availableCategories.forEach(cat => {
    const btn = document.createElement('button');
    btn.textContent = categoryIcons[cat] + ' ' + cat;
    btn.className = 'px-3 py-1 rounded-full border border-gray-300 text-gray-700 hover:bg-gray-200 transition cursor-pointer';
    btn.dataset.category = cat;

    // Toggle selected category for the chosen custom synergy
    btn.addEventListener('click', () => {
      if (!selectedCustomSynergyId) return;
      const chosen = customSynergies.find(s => s.id === selectedCustomSynergyId);
      if (!chosen) return;

      if (chosen.categories.includes(cat)) {
        chosen.categories = chosen.categories.filter(c => c !== cat);
        btn.classList.remove('bg-blue-500', 'text-white');
      } else {
        chosen.categories.push(cat);
        btn.classList.add('bg-blue-500', 'text-white');
      }

      renderTasks();
      saveCustomSynergies();
    });

    // Set active state if already selected
    if (selectedCustomSynergyId) {
      const chosen = customSynergies.find(s => s.id === selectedCustomSynergyId);
      if (chosen && chosen.categories.includes(cat)) {
        btn.classList.add('bg-blue-500', 'text-white');
      }
    }

    synergyCategoriesEl.appendChild(btn);
  });
}

function renderTaskCategoryFilters() {
  const container = document.getElementById('task-category-filters');
  container.innerHTML = ''; // clear existing buttons
  
  availableCategories.forEach(cat => {
    const btn = document.createElement('button');
    btn.textContent = categoryIcons[cat] + ' ' + cat;
    btn.className = 'px-3 py-1 rounded-full border border-gray-300 text-gray-700 hover:bg-gray-200 transition';
    btn.dataset.category = cat;

    btn.addEventListener('click', () => {
      btn.classList.toggle('bg-blue-500');
      btn.classList.toggle('text-white');
      renderTasks(); // re-render tasks to apply filtering/highlighting
    });

    container.appendChild(btn);
  });
}
function renderSavedSynergiesList() {
  savedSynergiesListEl.innerHTML = ''; // clear existing buttons

  customSynergies.forEach(s => {
    const btn = document.createElement('button');
    
    // Set the button content with a span for the name and a span for the red Ã—
    btn.innerHTML = `
      <span class="mr-2">${s.name}</span>
      <span class="text-red-500 hover:text-red-700 font-bold cursor-pointer">Ã—</span>
    `;

    btn.className = 'px-3 py-1 rounded-full border border-gray-300 text-gray-700 hover:bg-gray-200 transition flex items-center justify-between';
    
    if (selectedCustomSynergyId === s.id) {
      btn.classList.add('bg-blue-500', 'text-white');
    }

    // Click to select synergy (but not on the Ã—)
    btn.addEventListener('click', (e) => {
      if (e.target.tagName.toLowerCase() === 'span' && e.target.textContent === 'Ã—') return;
      selectedCustomSynergyId = s.id;
      renderSynergyCategories();
      renderSavedSynergiesList();
      renderTasks();
    });

    // Click the Ã— to delete
    btn.querySelector('span.text-red-500').addEventListener('click', (e) => {
      e.stopPropagation(); // prevent selecting the synergy
      customSynergies = customSynergies.filter(cs => cs.id !== s.id);
      if (selectedCustomSynergyId === s.id) selectedCustomSynergyId = null;
      saveCustomSynergies();
      renderSynergyCategories();
      renderSavedSynergiesList();
      renderTasks();
    });

    savedSynergiesListEl.appendChild(btn);
  });
}

function renderTasks() {
  taskTableBodyEl.innerHTML = '';
  const searchTerm = taskSearchEl.value.toLowerCase();

  // Get selected categories
  const selectedCats = Array.from(document.querySelectorAll('#task-category-filters button.bg-blue-500'))
                            .map(b => b.dataset.category);

  // Filter tasks based on search, category, and area
  const filtered = tasks.filter(t => {
    if (currentAreaFilter !== 'all' && t.Area !== currentAreaFilter) return false;
    if (!t.Task.toLowerCase().includes(searchTerm)) return false;
    if (selectedCats.length && !selectedCats.includes(getTaskCategory(t.Task))) return false;
    return true;
  });

  // Compute synergy scores for filtered tasks
  let scoredTasks = filtered.map(task => {
    const score = synergyMode === 'relic'
      ? calculateRelicSynergyScore(task).score
      : calculateCustomSynergyScore(task).score;
    return { ...task, score };
  });

  // Sort tasks based on dropdown selection
  const sortValue = sortByEl.value;
  scoredTasks.sort((a, b) => {
    if (sortValue === 'points-desc') return Number(b.Points) - Number(a.Points);
    if (sortValue === 'points-asc') return Number(a.Points) - Number(b.Points);
    if (sortValue === 'synergy-desc') return b.score - a.score;
	if (sortValue === 'synergy-asc') return a.score - b.score;
    return 0;
  });

  // Find the maximum synergy score after sorting
  const maxScore = Math.max(...scoredTasks.map(t => t.score), 0);

  // Render tasks in table
  scoredTasks.forEach(task => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="px-4 py-2 text-sm">${escapeHtml(task.Task)}</td>
      <td class="px-4 py-2 text-sm">${task.Points || 0}</td>
      <td class="px-4 py-2 text-sm">${escapeHtml(task.Requirements || 'N/A')}</td>
      <td class="px-4 py-2 text-sm">${task.score}</td>
    `;

    // Apply coloring based on synergy score
    if (task.score === maxScore && maxScore > 0) tr.classList.add('bg-green-200'); // top synergy
    else if (task.score >= 4) tr.classList.add('bg-green-100');
    else if (task.score >= 2) tr.classList.add('bg-yellow-100');
    else tr.classList.add('bg-gray-50');

    taskTableBodyEl.appendChild(tr);
  });

  // Update total synergy points
  totalPointsEl.textContent = scoredTasks.reduce((sum, t) => sum + t.score, 0);
}


/* ---------------------------
   Local Storage
   --------------------------- */
function saveRelicsToStorage() {
  localStorage.setItem('selectedRelics', JSON.stringify(selectedRelics));
}

function restoreRelicsFromStorage() {
  const data = localStorage.getItem('selectedRelics');
  if (!data) return;
  selectedRelics = JSON.parse(data);
}

function saveCustomSynergies() {
  localStorage.setItem('customSynergies', JSON.stringify(customSynergies));
}

function loadCustomSynergies() {
  const data = localStorage.getItem('customSynergies');
  if (!data) return;
  customSynergies = JSON.parse(data);
}

/* ---------------------------
   Event listeners
   --------------------------- */
taskSearchEl.addEventListener('input', renderTasks);
sortByEl.addEventListener('change', renderTasks);

saveSynergyBtn.addEventListener('click', () => {
  const name = synergyNameInput.value.trim();
  if (!name) return;
  const id = Date.now();
  customSynergies.push({ id, name, categories: [] });
  selectedCustomSynergyId = id;
  renderSynergyCategories();
  renderSavedSynergiesList(); // <-- important
  renderTasks();
  saveCustomSynergies();
  synergyNameInput.value = '';
});


/* ---------------------------
   Clear relics button
   --------------------------- */
const clearRelicsBtn = document.getElementById('clear-relics-btn');

clearRelicsBtn.addEventListener('click', () => {
  selectedRelics = {};             // Clear selected relics
  renderSelectedRelicDetails();    // Update relic build table
  renderRelicDropdowns();          // Reset dropdowns
  renderTasks();                   // Update task tracker
  saveRelicsToStorage();           // Clear local storage
});

// Initialize synergy mode buttons
function initSynergyModeToggle() {
  synergyModeToggleEl.querySelectorAll('button').forEach(btn => {
    const mode = btn.dataset.synergyMode;

    // Apply active/inactive styling based on current mode
    if (mode === synergyMode) {
      btn.classList.add('bg-blue-500', 'text-white', 'active');
      btn.classList.remove('bg-gray-300', 'text-gray-700');
    } else {
      btn.classList.remove('bg-blue-500', 'text-white', 'active');
      btn.classList.add('bg-gray-300', 'text-gray-700');
    }

    // Click handler
    btn.addEventListener('click', () => {
      // Remove active styling from all buttons
      synergyModeToggleEl.querySelectorAll('button').forEach(b => {
        b.classList.remove('bg-blue-500', 'text-white', 'active');
        b.classList.add('bg-gray-300', 'text-gray-700');
      });

      // Activate clicked button
      btn.classList.add('bg-blue-500', 'text-white', 'active');
      btn.classList.remove('bg-gray-300', 'text-gray-700');

      // Update mode
      synergyMode = mode;

      // Rerender task table and synergy categories
      renderTasks();
      renderSynergyCategories(); // <-- ensures category buttons are highlighted
    });
  });
}



/* ---------------------------
   Init
   --------------------------- */
(async function init() {
  await loadData();
  restoreRelicsFromStorage();
  loadCustomSynergies();
  renderSavedSynergiesList();
  renderRelicDropdowns();
  renderSelectedRelicDetails();
  renderAreaButtons();
  renderSynergyCategories();
  renderTasks();
  initSynergyModeToggle();
  setInterval(saveRelicsToStorage, 2000);
})();
</script>
</body>
</html>
