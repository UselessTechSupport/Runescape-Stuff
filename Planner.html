<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RS3 Leagues Synergy Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 1200px;
        }
        .relic-select {
            background-color: #fff;
            border-color: #d1d5db;
        }
        .relic-option-container {
            display: flex;
            align-items: center;
        }
        .relic-option-icon {
            width: 24px;
            height: 24px;
            margin-right: 8px;
            border-radius: 4px;
        }
        .synergy-score-very-high {
            background-color: #a7f3d0;
        }
        .synergy-score-high {
            background-color: #d1fae5;
        }
        .synergy-score-medium {
            background-color: #fef3c7;
        }
        .synergy-score-low {
            background-color: #fee2e2;
        }
        .area-button {
            transition: all 0.2s;
            border-radius: 9999px;
            padding: 0.5rem 1.25rem;
            border: 1px solid transparent;
            font-weight: 500;
        }
        .area-button.active {
            background-color: #3b82f6;
            color: #fff;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .area-button:not(.active) {
            background-color: #e5e7eb;
            color: #4b5563;
        }
        .area-button:hover:not(.active) {
            background-color: #d1d5db;
        }
        .task-checkbox:checked + label {
            background-color: #2563eb;
            color: #fff;
        }
        .task-checkbox:checked + label svg {
            color: #fff;
        }
        .task-checkbox:not(:checked) + label {
            background-color: #e5e7eb;
            color: #4b5563;
        }
        .task-checkbox:hover + label {
            background-color: #d1d5db;
        }
        .task-checkbox:checked:hover + label {
            background-color: #1e40af;
        }
        .toggle-btn {
            background-color: #e5e7eb;
            color: #4b5563;
            border-radius: 9999px;
            padding: 0.5rem 1rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        .toggle-btn.active {
            background-color: #3b82f6;
            color: #fff;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <div class="bg-white p-6 md:p-8 rounded-2xl shadow-lg mb-8">
            <h1 class="text-4xl font-bold text-center mb-2 text-gray-900">Catalyst League Planner</h1>
            <p class="text-center text-lg text-gray-600 mb-6">Select your relics to find the most synergistic tasks.</p>
            <div id="relic-planner" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <!-- Relic selection dropdowns will be rendered here by JS -->
            </div>
            <div id="selected-relics-container" class="mt-6 p-4 bg-gray-50 rounded-lg shadow-inner hidden">
                <h3 class="text-xl font-bold mb-2 text-gray-800">Your Relic Build</h3>
                <div class="overflow-x-auto rounded-lg">
                    <table id="selected-relics-table" class="min-w-full rounded-lg">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="px-4 py-2 text-left text-sm font-semibold text-gray-600 rounded-tl-lg">Tier</th>
                                <th class="px-4 py-2 text-left text-sm font-semibold text-gray-600">Relic</th>
                                <th class="px-4 py-2 text-left text-sm font-semibold text-gray-600 rounded-tr-lg">Description</th>
                            </tr>
                        </thead>
                        <tbody id="selected-relics-table-body" class="bg-white">
                            <!-- Relic details will be rendered here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="bg-white p-6 md:p-8 rounded-2xl shadow-lg mb-8">
            <h2 class="text-3xl font-bold mb-4 text-gray-900">Custom Synergy Rules</h2>
            <div id="custom-synergy-controls" class="space-y-4">
                <div class="flex flex-col md:flex-row items-center md:space-x-4 space-y-4 md:space-y-0">
                    <input type="text" id="synergy-name-input" placeholder="Enter synergy name" class="flex-grow p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200">
                    <button id="save-synergy-btn" class="w-full md:w-auto px-6 py-2 rounded-full bg-blue-500 text-white font-bold hover:bg-blue-600 transition-colors duration-200">Save Custom Synergy</button>
                </div>
                <div id="synergy-categories" class="flex flex-wrap gap-2 justify-center">
                    <!-- Category checkboxes will be rendered here -->
                </div>
                <div id="saved-synergies-list" class="flex flex-wrap gap-2 justify-center pt-4 border-t border-gray-200">
                    <!-- Saved synergy buttons will be rendered here -->
                </div>
            </div>
        </div>

        <div class="bg-white p-6 md:p-8 rounded-2xl shadow-lg mb-8">
            <h2 class="text-3xl font-bold mb-4 text-gray-900">Route Planner</h2>
            <div id="area-buttons" class="flex flex-wrap gap-2 mb-4">
                <button class="area-button bg-blue-500 text-white active" data-area-filter="all">All Areas</button>
            </div>
        </div>

        <div class="bg-white p-6 md:p-8 rounded-2xl shadow-lg">
            <h2 class="text-3xl font-bold mb-4 text-gray-900">Task Tracker</h2>
            <div class="flex flex-col sm:flex-row items-center gap-4 mb-4">
                <input type="text" id="task-search" placeholder="Search tasks..." class="w-full sm:w-1/2 p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200">
                <select id="sort-by" class="w-full sm:w-auto p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200">
                    <option value="points-desc">Sort by Points (High to Low)</option>
                    <option value="synergy-desc">Sort by Synergy (High to Low)</option>
                    <option value="points-asc">Sort by Points (Low to High)</option>
                </select>
                <div id="synergy-mode-toggle" class="flex space-x-2">
                    <button class="toggle-btn active" data-synergy-mode="relic">Relic Synergy</button>
                    <button class="toggle-btn" data-synergy-mode="custom">Custom Synergy</button>
                </div>
            </div>
            
            <div class="overflow-x-auto rounded-lg">
                <table id="task-table" class="min-w-full bg-white rounded-lg">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600 rounded-tl-lg">Task</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Points</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Requirements</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600 rounded-tr-lg">Synergy Score</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Task rows will be rendered here by JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, onSnapshot, collection, query, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase access
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Initialize Firebase
        let app, db, auth, userId;
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('Debug');
        } catch (error) {
            console.error("Firebase initialization error:", error);
        }

        const authUser = async () => {
            if (!auth) {
                console.error("Firebase Auth not initialized.");
                return;
            }
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                userId = auth.currentUser?.uid || crypto.randomUUID();
                console.log("Authenticated as:", userId);
            } catch (error) {
                console.error("Firebase authentication error:", error);
            }
        };

        const relics = [
            { Tier: 1, Relic1: 'Excavator', Relic2: 'Divine Woodcutter', Relic3: 'Animal Wrangler', Synergy: ['Gathering', 'Skilling', 'Production'], PassiveSynergy: ['Gathering', 'Production'], Relic1Details: "Automatically processes resources as you gather them, providing instant XP and products.", Relic2Details: "Chop trees at a faster rate with a chance to instantly deplete a tree.", Relic3Details: "Traps and creatures you interact with will yield extra resources and XP.", Relic1Image: "", Relic2Image: "", Relic3Image: "" },
            { Tier: 2, Relic1: 'Golden Footed', Relic2: 'Five Finger Discount', Relic3: 'Farming Frenzy', Synergy: ['Skilling', 'Utility', 'Production'], PassiveSynergy: ['Production'], Relic1Details: "Increases your Agility and Thieving XP gains. All Agility obstacles grant bonus XP.", Relic2Details: "Gives a chance to steal multiple items from a single pickpocket.", Relic3Details: "Automatically harvests crops as they grow, granting bonus XP and resources.", Relic1Image: "", Relic2Image: "", Relic3Image: "" },
            { Tier: 3, Relic1: 'Fairy\'s Flight', Relic2: 'Assassin\'s Insight', Relic3: 'Voidwalker', Synergy: ['Skilling', 'Combat', 'Utility', 'Dungeons'], PassiveSynergy: ['Production'], Relic1Details: "Allows you to teleport to many locations with a single click, without using runes.", Relic2Details: "Provides a bonus to all combat damage against monsters you have slain previously.", Relic3Details: "Grants a chance to instantly kill monsters you are fighting.", Relic1Image: "", Relic2Image: "", Relic3Image: "" },
            { Tier: 4, Relic1: 'Production Master', Relic2: 'Rejuvenated', Relic3: 'Clue Connoisseur', Synergy: ['Production', 'Combat', 'Clues', 'Utility'], PassiveSynergy: ['Combat'], Relic1Details: "All your production skills will be much faster and consume less resources.", Relic2Details: "Your life points regenerate at an extremely fast rate, making you nearly invincible.", Relic3Details: "All clue scrolls become easier to complete and give better rewards.", Relic1Image: "", Relic2Image: "", Relic3Image: "" },
            { Tier: 5, Relic1: 'Barbarism', Relic2: 'Crit Happens', Relic3: 'Bombardment / Soulbourne', Synergy: ['Combat', 'Bossing'], PassiveSynergy: ['Combat'], Relic1Details: "Allows you to use any combat style effectively, regardless of weapon or armour.", Relic2Details: "Increases your critical strike chance and damage.", Relic3: 'Bombardment / Soulbourne', Relic3Details: "Spells and abilities have a chance to hit all enemies in an area.", Relic1Image: "", Relic2Image: "", Relic3Image: "" },
            { Tier: 6, Relic1: 'Banker\'s Note', Relic2: 'Perfektion', Relic3: 'Slayer Saviour', Synergy: ['Utility', 'Combat', 'Slayer'], PassiveSynergy: ['Gathering', 'Production'], Relic1Details: "Allows you to turn any item into a note, allowing for infinite inventory space.", Relic2Details: "Your damage and accuracy will scale with the number of your unlocked achievements.", Relic3Details: "All Slayer tasks are completed faster and provide bonus rewards.", Relic1Image: "", Relic2Image: "", Relic3Image: "" },
            { Tier: 7, Relic1: 'Ascension', Relic2: 'Specialist', Relic3: 'Everlasting Faith', Synergy: ['Combat', 'Bossing', 'PVM'], PassiveSynergy: ['PVM', 'Bossing'], Relic1Details: "A powerful damage boost that scales with your combat level.", Relic2Details: "Your attacks have a chance to deal additional damage based on your opponent's life points.", Relic3Details: "Grants a powerful resurrection effect, allowing you to survive lethal blows.", Relic1Image: "", Relic2Image: "", Relic3Image: "" }
        ];

        const tasks = [
            { Task: "Progress through the Leagues tutorial to unlock your first relic.", Points: 10, Requirements: "N/A", Area: "Tutorial" },
            { Task: "Have Ned make you some rope from balls of wool.", Points: 10, Requirements: "N/A", Area: "Lumbridge" },
            { Task: "Kill a goblin in Lumbridge.", Points: 10, Requirements: "N/A", Area: "Lumbridge" },
            { Task: "Kill a giant rat in Lumbridge Swamp.", Points: 10, Requirements: "N/A", Area: "Lumbridge" },
            { Task: "Kill a mugger near the Edgeville lodestone.", Points: 10, Requirements: "N/A", Area: "Lumbridge" },
            { Task: "Chop a regular tree.", Points: 10, Requirements: "1 Woodcutting", Area: "Any" },
            { Task: "Bake a cake.", Points: 10, Requirements: "40 Cooking", Area: "Any" },
            { Task: "Make a fire.", Points: 10, Requirements: "1 Firemaking", Area: "Any" },
            { Task: "Cook a fish on a fire.", Points: 10, Requirements: "1 Cooking", Area: "Any" },
            { Task: "Equip any 2 pieces of an Elegant outfit.", Points: 30, Requirements: "N/A", Area: "General" },
            { Task: "Equip a composite bow of any kind.", Points: 30, Requirements: "20 Ranged", Area: "General" },
            { Task: "Perform a Special Attack.", Points: 30, Requirements: "5 Attack or 5 Ranged or 5 Magic (claimed from Gudrik in Port Sarim)", Area: "General" },
            { Task: "Reach level 30 in any skill.", Points: 30, Requirements: "N/A", Area: "General" },
            { Task: "Reach level 40 in any skill.", Points: 30, Requirements: "N/A", Area: "General" },
            { Task: "Craft 25 runes.", Points: 30, Requirements: "1 Runecrafting", Area: "Any" },
            { Task: "Create 25 summoning scrolls from pouches.", Points: 30, Requirements: "1 Summoning", Area: "Any" },
            { Task: "Convert at least one pale memory into energy.", Points: 10, Requirements: "N/A", Area: "Lumbridge" },
            { Task: "Complete a lap of the gnome Stronghold Agility Course.", Points: 10, Requirements: "25 Agility", Area: "Gnome Stronghold" },
            { Task: "Use the bank in the workshop at Fort Forinthry.", Points: 10, Requirements: "Partial completion of New Foundations", Area: "Fort Forinthry" },
            { Task: "Craft a rune helm.", Points: 50, Requirements: "89 Smithing", Area: "Any" },
            { Task: "Complete the Rune Mysteries quest.", Points: 50, Requirements: "N/A", Area: "Lumbridge" },
            { Task: "Mine 1,000,000 progress in a single Mining session.", Points: 100, Requirements: "N/A", Area: "Any" },
            { Task: "Siphon from a fire essling in the Runespan.", Points: 10, Requirements: "14 Runecrafting", Area: "Lumbridge" },
            { Task: "Complete 25 Hard clue scrolls.", Points: 30, Requirements: "N/A", Area: "Clues" },
            { Task: "Collect 5 unique items for the Easy clue rewards collection log.", Points: 30, Requirements: "N/A", Area: "Clues" },
            { Task: "Collect 10 unique items for the Easy clue rewards collection log.", Points: 30, Requirements: "N/A", Area: "Clues" },
            { Task: "Collect 5 unique items for the Medium clue rewards collection log.", Points: 30, Requirements: "N/A", Area: "Clues" },
            { Task: "Collect 10 unique items for the Medium clue rewards collection log.", Points: 30, Requirements: "N/A", Area: "Clues" },
            { Task: "Collect 5 unique items for the Hard clue rewards collection log.", Points: 30, Requirements: "N/A", Area: "Clues" },
            { Task: "Enter the Lumbridge Swamp Caves.", Points: 10, Requirements: "N/A", Area: "Lumbridge" },
            { Task: "Equip a bronze platebody.", Points: 10, Requirements: "10 Defence", Area: "Any" },
            { Task: "Find the hidden entrance in the Lumbridge Castle kitchen.", Points: 10, Requirements: "N/A", Area: "Lumbridge" },
            { Task: "Cut a willow tree.", Points: 10, Requirements: "30 Woodcutting", Area: "Any" },
            { Task: "Mine some coal in the centre of Barbarian village.", Points: 10, Requirements: "20 Mining", Area: "Barbarian Village" },
            { Task: "Reach level 99 in a skill.", Points: 100, Requirements: "N/A", Area: "Any" },
            { Task: "Reach level 120 in a skill.", Points: 100, Requirements: "N/A", Area: "Any" },
            { Task: "Complete a Slayer task.", Points: 30, Requirements: "N/A", Area: "Any" },
            { Task: "Catch a raw salmon.", Points: 10, Requirements: "20 Fishing", Area: "Any" },
            { Task: "Cook a raw salmon.", Points: 10, Requirements: "25 Cooking", Area: "Any" },
            { Task: "Loot a medium lootbag.", Points: 30, Requirements: "N/A", Area: "Any" },
            { Task: "Defeat the giant mole.", Points: 50, Requirements: "N/A", Area: "Any" },
            { Task: "Complete a treasure trail.", Points: 10, Requirements: "N/A", Area: "Any" },
            { Task: "Open a Hard casket.", Points: 30, Requirements: "N/A", Area: "Any" },
            { Task: "Receive a drop from a boss.", Points: 30, Requirements: "N/A", Area: "Any" },
            { Task: "Open the bank in the Edgeville Monastery.", Points: 10, Requirements: "N/A", Area: "Edgeville" },
            { Task: "Defeat a waterfiend.", Points: 10, Requirements: "N/A", Area: "Waterfiend" },
            { Task: "Receive a drop from a kalphite.", Points: 10, Requirements: "N/A", Area: "Desert" },
            { Task: "Open a Hard lootbag.", Points: 50, Requirements: "N/A", Area: "Any" },
            { Task: "Defeat a high level boss.", Points: 100, Requirements: "N/A", Area: "Any" },
            { Task: "Catch a rocktail.", Points: 50, Requirements: "90 Fishing", Area: "Any" },
            { Task: "Craft an abyssal whip.", Points: 50, Requirements: "85 Attack", Area: "Any" },
            { Task: "Mine a piece of Luminite.", Points: 30, Requirements: "40 Mining", Area: "Any" },
            { Task: "Complete the Death Plateau quest.", Points: 30, Requirements: "N/A", Area: "Death Plateau" },
            { Task: "Complete the Vampire Slayer quest.", Points: 30, Requirements: "N/A", Area: "Draynor" },
            { Task: "Complete the Animal Magnetism quest.", Points: 50, Requirements: "N/A", Area: "Draynor" },
            { Task: "Receive a drop from a troll.", Points: 10, Requirements: "N/A", Area: "Troll" },
            { Task: "Defeat the Chaos Elemental.", Points: 50, Requirements: "N/A", Area: "Wilderness" },
            { Task: "Complete a lap of the Wilderness Agility Course.", Points: 30, Requirements: "52 Agility", Area: "Wilderness" },
            { Task: "Open a master casket.", Points: 100, Requirements: "N/A", Area: "Clues" },
            { Task: "Open a master lootbag.", Points: 100, Requirements: "N/A", Area: "Clues" },
            { Task: "Defeat a corrupted creature.", Points: 100, Requirements: "N/A", Area: "Corrupted" },
            { Task: "Create a corrupted armour piece.", Points: 100, Requirements: "N/A", Area: "Corrupted" },
            { Task: "Defeat a spiritual creature.", Points: 10, Requirements: "N/A", Area: "Spiritual" },
            { Task: "Defeat a demonic creature.", Points: 10, Requirements: "N/A", Area: "Demonic" },
            { Task: "Defeat a dragon.", Points: 10, Requirements: "N/A", Area: "Any" },
            { Task: "Defeat the King Black Dragon.", Points: 50, Requirements: "N/A", Area: "Wilderness" },
            { Task: "Complete a barrows run.", Points: 50, Requirements: "N/A", Area: "Morytania" },
            { Task: "Defeat a god wars dungeon boss.", Points: 100, Requirements: "N/A", Area: "God Wars" },
            { Task: "Defeat the Kalphite King.", Points: 100, Requirements: "N/A", Area: "Desert" },
            { Task: "Defeat the Queen Black Dragon.", Points: 100, Requirements: "N/A", Area: "QBD" },
            { Task: "Complete the Dungeoneering tutorial.", Points: 10, Requirements: "N/A", Area: "Dungeoneering" },
            { Task: "Complete a Dungeoneering floor.", Points: 30, Requirements: "N/A", Area: "Dungeoneering" },
            { Task: "Complete a Dungeoneering floor on a large dungeon.", Points: 50, Requirements: "N/A", Area: "Dungeoneering" },
            { Task: "Open a loot bag from a dungeon.", Points: 30, Requirements: "N/A", Area: "Dungeoneering" },
            { Task: "Complete a full large Dungeoneering run.", Points: 100, Requirements: "N/A", Area: "Dungeoneering" },
            { Task: "Craft an arcane sigil.", Points: 100, Requirements: "95 Runecrafting", Area: "Any" },
            { Task: "Fletch 1000 headless arrows.", Points: 30, Requirements: "1 Fletching", Area: "Any" },
            { Task: "Fletch 1000 adamant bolts.", Points: 50, Requirements: "59 Fletching", Area: "Any" },
            { Task: "Cook 1000 lobsters.", Points: 50, Requirements: "40 Cooking", Area: "Any" },
            { Task: "Mine 1000 adamant ore.", Points: 50, Requirements: "70 Mining", Area: "Any" },
            { Task: "Cut 1000 yew logs.", Points: 50, Requirements: "60 Woodcutting", Area: "Any" },
            { Task: "Craft a cosmic rune.", Points: 10, Requirements: "27 Runecrafting", Area: "Any" },
            { Task: "Craft an astral rune.", Points: 30, Requirements: "40 Runecrafting", Area: "Any" },
            { Task: "Craft a lava rune.", Points: 50, Requirements: "40 Runecrafting", Area: "Any" },
            { Task: "Receive a drop from a boss on a slayer task.", Points: 100, Requirements: "N/A", Area: "Any" },
            { Task: "Complete 100 slayer tasks.", Points: 100, Requirements: "N/A", Area: "Any" },
            { Task: "Craft 1,000,000 progress in a single crafting session.", Points: 100, Requirements: "N/A", Area: "Any" },
            { Task: "Make 100,000 progress in a single cooking session.", Points: 50, Requirements: "N/A", Area: "Any" },
            { Task: "Defeat a celestial creature.", Points: 10, Requirements: "N/A", Area: "Any" },
            { Task: "Defeat a skeletal creature.", Points: 10, Requirements: "N/A", Area: "Any" },
            { Task: "Defeat a demonic creature in the Wilderness.", Points: 30, Requirements: "N/A", Area: "Wilderness" },
            { Task: "Defeat a dragon in the Wilderness.", Points: 30, Requirements: "N/A", Area: "Wilderness" },
            { Task: "Defeat a chaos elemental.", Points: 50, Requirements: "N/A", Area: "Wilderness" },
            { Task: "Equip a t90 weapon.", Points: 100, Requirements: "90 Attack/Strength/Magic/Ranged", Area: "Any" },
            { Task: "Obtain a soul of a high-level boss.", Points: 100, Requirements: "N/A", Area: "Any" },
            { Task: "Obtain a soul of a specific Slayer creature.", Points: 50, Requirements: "N/A", Area: "Slayer" },
            { Task: "Unlock the Soul Reaper relic.", Points: 100, Requirements: "N/A", Area: "Reaper" },
            { Task: "Defeat a boss that you've soul-reaped.", Points: 100, Requirements: "N/A", Area: "Any" },
            { Task: "Craft a master quest cape.", Points: 100, Requirements: "N/A", Area: "Any" },
            { Task: "Complete a full large Dungeoneering run with a full group.", Points: 100, Requirements: "N/A", Area: "Dungeoneering" },
            { Task: "Complete the World Wakes quest.", Points: 100, Requirements: "N/A", Area: "Any" },
            { Task: "Obtain a boss pet.", Points: 100, Requirements: "N/A", Area: "Any" },
            { Task: "Catch a shark.", Points: 30, Requirements: "76 Fishing", Area: "Any" },
            { Task: "Craft a fire rune.", Points: 10, Requirements: "14 Runecrafting", Area: "Any" },
            { Task: "Cook a shark.", Points: 30, Requirements: "80 Cooking", Area: "Any" },
            { Task: "Smith a platebody.", Points: 30, Requirements: "20 Smithing", Area: "Any" },
            { Task: "Smith a rune scimitar.", Points: 50, Requirements: "85 Smithing", Area: "Any" },
            { Task: "Gather 100,000 progress in a single gathering session.", Points: 50, Requirements: "N/A", Area: "Any" },
            { Task: "Gain 1,000,000 XP in a single skill.", Points: 100, Requirements: "N/A", Area: "Any" },
            { Task: "Obtain an elite clue scroll.", Points: 50, Requirements: "N/A", Area: "Clues" },
            { Task: "Obtain a master clue scroll.", Points: 100, Requirements: "N/A", Area: "Clues" },
            { Task: "Equip a tier 80+ power armour set.", Points: 100, Requirements: "80 Defence", Area: "Any" },
            { Task: "Complete 1,000 slayer tasks.", Points: 100, Requirements: "N/A", Area: "Any" },
            { Task: "Obtain a champion's scroll.", Points: 100, Requirements: "N/A", Area: "Any" },
            { Task: "Obtain a special drop from a slayer monster.", Points: 50, Requirements: "N/A", Area: "Any" },
            { Task: "Complete a master treasure trail.", Points: 100, Requirements: "N/A", Area: "Clues" },
            { Task: "Open a hard lootbag.", Points: 50, Requirements: "N/A", Area: "Any" },
            { Task: "Open an elite lootbag.", Points: 50, Requirements: "N/A", Area: "Any" },
            { Task: "Open a master lootbag.", Points: 100, Requirements: "N/A", Area: "Any" },
            { Task: "Defeat a boss in the Wilderness.", Points: 100, Requirements: "N/A", Area: "Wilderness" }
        ];

        const getTaskCategory = (task) => {
            const lowerTask = task.toLowerCase();
            if (lowerTask.includes('clue') || lowerTask.includes('casket') || lowerTask.includes('treasure trail')) return 'Clues';
            if (lowerTask.includes('woodcutting') || lowerTask.includes('mining') || lowerTask.includes('fishing') || lowerTask.includes('gather') || lowerTask.includes('harvest')) return 'Gathering';
            if (lowerTask.includes('craft') || lowerTask.includes('smith') || lowerTask.includes('fletch') || lowerTask.includes('cook') || lowerTask.includes('make') || lowerTask.includes('rune helm')) return 'Production';
            if (lowerTask.includes('kill') || lowerTask.includes('slay') || lowerTask.includes('defeat') || lowerTask.includes('combat') || lowerTask.includes('fight') || lowerTask.includes('attack') || lowerTask.includes('pvp')) return 'Combat';
            if (lowerTask.includes('skill') || lowerTask.includes('level') || lowerTask.includes('xp') || lowerTask.includes('agility') || lowerTask.includes('firemaking')) return 'Skilling';
            if (lowerTask.includes('bank') || lowerTask.includes('runespan') || lowerTask.includes('teleport') || lowerTask.includes('lootbag') || lowerTask.includes('loot bag')) return 'Utility';
            if (lowerTask.includes('dungeon') || lowerTask.includes('dungeoneering')) return 'Dungeons';
            if (lowerTask.includes('boss')) return 'Bossing';
            if (lowerTask.includes('slayer')) return 'Slayer';
            if (lowerTask.includes('pvm')) return 'PVM';
            return 'General';
        };
        
        const categoryIcons = {
            'Clues': '🗺️',
            'Gathering': '⛏️',
            'Production': '🛠️',
            'Combat': '⚔️',
            'Skilling': '🎓',
            'Utility': '🎒',
            'Dungeons': '🗝️',
            'Bossing': '👹',
            'Slayer': '🐉',
            'PVM': '🛡️',
            'General': '✨'
        };

        const availableCategories = ['Clues', 'Gathering', 'Production', 'Combat', 'Skilling', 'Utility', 'Dungeons', 'Bossing', 'Slayer', 'PVM'];

        let selectedRelics = {};
        let customSynergies = [];
        let selectedCustomSynergyId = null;
        let synergyMode = 'relic';
        let currentAreaFilter = 'all';

        const relicPlannerEl = document.getElementById('relic-planner');
        const selectedRelicsContainerEl = document.getElementById('selected-relics-container');
        const selectedRelicsTableBodyEl = document.getElementById('selected-relics-table-body');
        const taskTableBodyEl = document.getElementById('task-table').querySelector('tbody');
        const taskSearchEl = document.getElementById('task-search');
        const sortByEl = document.getElementById('sort-by');
        const areaButtonsEl = document.getElementById('area-buttons');
        const synergyNameInput = document.getElementById('synergy-name-input');
        const saveSynergyBtn = document.getElementById('save-synergy-btn');
        const synergyCategoriesEl = document.getElementById('synergy-categories');
        const savedSynergiesListEl = document.getElementById('saved-synergies-list');
        const synergyModeToggleEl = document.getElementById('synergy-mode-toggle');

        const renderSelectedRelicDetails = () => {
            selectedRelicsTableBodyEl.innerHTML = '';
            const selectedTiers = Object.keys(selectedRelics).sort((a, b) => a - b);
            
            if (selectedTiers.length === 0) {
                selectedRelicsContainerEl.classList.add('hidden');
                return;
            } else {
                selectedRelicsContainerEl.classList.remove('hidden');
            }

            selectedTiers.forEach(tier => {
                const selectedRelic = selectedRelics[tier];
                const relicTierData = relics.find(r => r.Tier === parseInt(tier));
                let details = '';
                let imageTag = '';

                if (selectedRelic.name === relicTierData.Relic1) {
                    details = relicTierData.Relic1Details;
                    imageTag = relicTierData.Relic1Image;
                } else if (selectedRelic.name === relicTierData.Relic2) {
                    details = relicTierData.Relic2Details;
                    imageTag = relicTierData.Relic2Image;
                } else if (selectedRelic.name === relicTierData.Relic3) {
                    details = relicTierData.Relic3Details;
                    imageTag = relicTierData.Relic3Image;
                }

                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200';
                row.innerHTML = `
                    <td class="px-4 py-2 text-sm text-gray-900">Tier ${tier}</td>
                    <td class="px-4 py-2 text-sm text-gray-900 flex items-center gap-2"><span>${imageTag}</span> ${selectedRelic.name}</td>
                    <td class="px-4 py-2 text-sm text-gray-900">${details}</td>
                `;
                selectedRelicsTableBodyEl.appendChild(row);
            });
        };

        const renderRelicDropdowns = () => {
            relics.forEach(relic => {
                const tierEl = document.createElement('div');
                tierEl.className = "bg-gray-100 p-4 rounded-lg shadow-inner";
                tierEl.innerHTML = `
                    <label for="relic-tier-${relic.Tier}" class="block text-sm font-medium text-gray-700 mb-1">Tier ${relic.Tier}</label>
                    <select id="relic-tier-${relic.Tier}" class="relic-select block w-full rounded-md shadow-sm p-2 text-gray-700">
                        <option value="">Select Relic</option>
                        ${relic.Relic1 ? `<option value="${relic.Relic1}">${relic.Relic1Image} ${relic.Relic1}</option>` : ''}
                        ${relic.Relic2 ? `<option value="${relic.Relic2}">${relic.Relic2Image} ${relic.Relic2}</option>` : ''}
                        ${relic.Relic3 ? `<option value="${relic.Relic3}">${relic.Relic3Image} ${relic.Relic3}</option>` : ''}
                    </select>
                `;
                relicPlannerEl.appendChild(tierEl);

                tierEl.querySelector('select').addEventListener('change', (e) => {
                    const selectedRelicName = e.target.value;
                    if (selectedRelicName) {
                        const selectedRelic = relics.find(r => r.Relic1 === selectedRelicName || r.Relic2 === selectedRelicName || r.Relic3 === selectedRelicName);
                        selectedRelics[relic.Tier] = { name: selectedRelicName, synergies: selectedRelic.Synergy, tier: relic.Tier };
                    } else {
                        delete selectedRelics[relic.Tier];
                    }
                    renderSelectedRelicDetails();
                    renderTasks();
                });
            });
        };

        const calculateRelicSynergyScore = (task) => {
            let score = 0;
            const taskCategory = getTaskCategory(task.Task);
            if (!taskCategory) return 0;

            relics.forEach(relicTier => {
                const passiveSynergies = relicTier.PassiveSynergy;
                if (passiveSynergies && passiveSynergies.includes(taskCategory)) {
                    score += 1;
                }
                
                const selectedRelic = selectedRelics[relicTier.Tier];
                if (selectedRelic && selectedRelic.synergies.includes(taskCategory)) {
                    score += selectedRelic.synergies.length;
                }
            });
            return score;
        };

        const calculateCustomSynergyScore = (task) => {
            if (!selectedCustomSynergyId) return 0;
            const selectedCustomSynergy = customSynergies.find(s => s.id === selectedCustomSynergyId);
            if (!selectedCustomSynergy) return 0;

            let score = 0;
            const taskCategory = getTaskCategory(task.Task);
            if (taskCategory && selectedCustomSynergy.categories.includes(taskCategory)) {
                score = 10;
            }
            return score;
        };

        const renderTasks = () => {
            const searchTerm = taskSearchEl.value.toLowerCase();
            const sortBy = sortByEl.value;

            let filteredTasks = tasks;
            if (currentAreaFilter !== 'all') {
                filteredTasks = filteredTasks.filter(task => task.Area === currentAreaFilter);
            }
            
            filteredTasks = filteredTasks.filter(task => 
                task.Task.toLowerCase().includes(searchTerm) || 
                task.Requirements.toLowerCase().includes(searchTerm) ||
                task.Area.toLowerCase().includes(searchTerm)
            );

            filteredTasks = filteredTasks.map(task => {
                const synergyScore = synergyMode === 'relic' ? calculateRelicSynergyScore(task) : calculateCustomSynergyScore(task);
                return {
                    ...task,
                    synergyScore: synergyScore
                };
            });

            filteredTasks.sort((a, b) => {
                if (sortBy === 'points-desc') return b.Points - a.Points;
                if (sortBy === 'points-asc') return a.Points - b.Points;
                if (sortBy === 'synergy-desc') return b.synergyScore - a.synergyScore;
            });
            
            taskTableBodyEl.innerHTML = '';

            filteredTasks.forEach(task => {
                const taskCategory = getTaskCategory(task.Task);
                const icon = categoryIcons[taskCategory] || '❓';
                const row = document.createElement('tr');
                let synergyClass = 'bg-white';
                if (task.synergyScore > 10) {
                    synergyClass = 'synergy-score-very-high';
                } else if (task.synergyScore > 4) {
                    synergyClass = 'synergy-score-high';
                } else if (task.synergyScore > 1) {
                    synergyClass = 'synergy-score-medium';
                } else if (task.synergyScore > 0) {
                    synergyClass = 'synergy-score-low';
                }
                
                row.className = `border-b border-gray-200 transition-all duration-200 hover:bg-gray-50 ${synergyClass}`;
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm text-gray-900">${icon} ${task.Task}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${task.Points}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${task.Requirements}</td>
                    <td class="px-4 py-3 text-sm font-bold text-gray-900">${task.synergyScore}</td>
                `;
                taskTableBodyEl.appendChild(row);
            });
        };
        
        const renderAreaButtons = () => {
            const areas = [...new Set(tasks.map(task => task.Area))];
            areas.sort();
            areas.forEach(area => {
                const button = document.createElement('button');
                button.className = 'area-button';
                button.textContent = area;
                button.dataset.areaFilter = area;
                areaButtonsEl.appendChild(button);

                button.addEventListener('click', () => {
                    document.querySelectorAll('.area-button').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    currentAreaFilter = button.dataset.areaFilter;
                    renderTasks();
                });
            });
        };

        const renderSynergyCategories = () => {
            synergyCategoriesEl.innerHTML = '';
            availableCategories.forEach(category => {
                const checkboxId = `cat-${category}`;
                const div = document.createElement('div');
                div.className = 'flex items-center';
                div.innerHTML = `
                    <input type="checkbox" id="${checkboxId}" value="${category}" class="task-checkbox hidden">
                    <label for="${checkboxId}" class="px-4 py-2 rounded-full cursor-pointer font-medium transition-colors duration-200">
                        ${categoryIcons[category] || '❓'} ${category}
                    </label>
                `;
                synergyCategoriesEl.appendChild(div);
            });
        };

        const renderSavedSynergies = () => {
            savedSynergiesListEl.innerHTML = '';
            customSynergies.forEach(synergy => {
                const button = document.createElement('button');
                button.className = `area-button ${selectedCustomSynergyId === synergy.id ? 'active' : ''}`;
                button.textContent = synergy.name;
                button.dataset.synergyId = synergy.id;
                savedSynergiesListEl.appendChild(button);
                button.addEventListener('click', (e) => {
                    selectedCustomSynergyId = e.target.dataset.synergyId;
                    renderSavedSynergies();
                    renderTasks();
                });
            });
        };

        const saveSynergy = async () => {
            const synergyName = synergyNameInput.value.trim();
            const selectedCategories = Array.from(synergyCategoriesEl.querySelectorAll('input:checked')).map(cb => cb.value);

            if (!synergyName || selectedCategories.length === 0) {
                console.error("Please provide a name and select at least one category.");
                return;
            }

            if (!userId) {
                console.error("User not authenticated. Cannot save synergy.");
                return;
            }

            const docRef = await addDoc(collection(db, `artifacts/${appId}/users/${userId}/custom-synergies`), {
                name: synergyName,
                categories: selectedCategories
            });
            console.log("Custom synergy saved with ID:", docRef.id);
            synergyNameInput.value = '';
            synergyCategoriesEl.querySelectorAll('input:checked').forEach(cb => cb.checked = false);
        };

        const initializeFirestoreListener = async () => {
            if (!db || !userId) {
                console.error("Firestore not initialized or user ID missing.");
                return;
            }
            onSnapshot(collection(db, `artifacts/${appId}/users/${userId}/custom-synergies`), (snapshot) => {
                customSynergies = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderSavedSynergies();
                renderTasks();
            });
        };
        
        const setupEventListeners = () => {
            saveSynergyBtn.addEventListener('click', saveSynergy);
            taskSearchEl.addEventListener('input', renderTasks);
            sortByEl.addEventListener('change', renderTasks);
            synergyModeToggleEl.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    synergyMode = e.target.dataset.synergy-mode;
                    synergyModeToggleEl.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    renderTasks();
                }
            });
        };

        window.onload = async () => {
            await authUser();
            renderRelicDropdowns();
            renderSelectedRelicDetails();
            renderAreaButtons();
            renderSynergyCategories();
            setupEventListeners();
            await initializeFirestoreListener();
            renderTasks();
        };

    </script>
</body>
</html>
